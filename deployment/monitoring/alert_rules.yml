groups:
- name: voice-ai-alerts
  rules:
  - alert: HighCPUUsage
    expr: (100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High CPU usage detected ({{ $value }}%)"
      description: "CPU usage is above 80% for more than 5 minutes on {{ $labels.instance }}"

  - alert: HighMemoryUsage
    expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High memory usage detected ({{ $value }}%)"
      description: "Memory usage is above 85% for more than 5 minutes on {{ $labels.instance }}"

  - alert: HighDiskUsage
    expr: (node_filesystem_size_bytes{fstype=~"ext4|xfs"} - node_filesystem_free_bytes{fstype=~"ext4|xfs"}) / node_filesystem_size_bytes{fstype=~"ext4|xfs"} * 100 > 85
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High disk usage detected ({{ $value }}%)"
      description: "Disk usage is above 85% for more than 5 minutes on {{ $labels.instance }} (mount point: {{ $labels.mountpoint }})"

  - alert: ServiceDown
    expr: up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Service down: {{ $labels.job }}"
      description: "{{ $labels.job }} on {{ $labels.instance }} has been down for more than 1 minute"

  - alert: SlowAPIResponse
    expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="voice-ai-api"}[5m])) by (le, route)) > 1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Slow API response time for {{ $labels.route }}"
      description: "95th percentile of response time for {{ $labels.route }} is above 1 second for more than 5 minutes"

  - alert: HighErrorRate
    expr: sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m])) * 100 > 5
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "High error rate: {{ $value }}%"
      description: "Error rate is above 5% for more than 1 minute"

  - alert: MLModelLatency
    expr: histogram_quantile(0.95, sum(rate(ml_inference_duration_seconds_bucket[5m])) by (le, model)) > 0.5
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "ML model inference latency: {{ $labels.model }}"
      description: "95th percentile of inference time for {{ $labels.model }} is above 0.5 seconds for more than 5 minutes"

  - alert: DatabaseConnections
    expr: sum(pg_stat_activity_count) > 150
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High number of database connections: {{ $value }}"
      description: "Number of database connections has been above 150 for more than 5 minutes"

  - alert: RedisMemoryUsage
    expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Redis memory usage: {{ $value }}%"
      description: "Redis memory usage has been above 80% for more than 5 minutes"

  - alert: FailedCalls
    expr: rate(voice_ai_calls_failed_total[15m]) > 5
    for: 15m
    labels:
      severity: warning
    annotations:
      summary: "High rate of failed calls: {{ $value }} calls/min"
      description: "The rate of failed calls has been above 5 per minute for more than 15 minutes"

  - alert: EmotionDetectionFailure
    expr: rate(voice_ai_emotion_detection_failures_total[15m]) > 10
    for: 15m
    labels:
      severity: warning
    annotations:
      summary: "High rate of emotion detection failures: {{ $value }} failures/min"
      description: "The rate of emotion detection failures has been above 10 per minute for more than 15 minutes"
